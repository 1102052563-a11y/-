# 剧情指导 StoryGuide（SillyTavern 扩展）

## v0.5.1：世界书导入注入 + 预设导入导出（并修复 worldBookText 报错）

### 为什么会出现 `worldBookText is not defined`
旧版把世界书文本当作变量 `worldBookText` 插到 buildSnapshot 里，但没有声明该变量，所以导入后仍会报错。

v0.5.1 已改为：导入后存进 `settings.worldbookJson`，并在 buildSnapshot 内通过 `buildWorldbookBlock()` 生成要注入的文本。

### 世界书（World Info / Lorebook）
- 导入：面板 →「预设与世界书」→ 导入世界书JSON
- 勾选：在分析输入中注入世界书
- 模式：
  - active：仅注入可能激活条目（关键词匹配最近消息）
  - all：注入全部条目

### 预设
- 导出预设：可选是否包含 API Key
- 导入预设：覆盖当前插件设置（建议导入后刷新页面一次）


## v0.7.4
- 优化面板按钮布局（不再竖排）
- 移除“本聊天专用”区块（与自定义提示重复）


## v0.7.4
- 修复面板按钮竖排（保存设置/分析/刷新模型等）
- 缩小扩展列表中的“打开面板”按钮占用


## v0.7.4
- 修复扩展页“打开面板”按钮仍竖排/占用过大


## v0.7.4
- 移除顶栏📘入口按钮（仅保留扩展页“打开面板”与聊天区生成/重Roll按钮）


## v0.7.4
- 修复“同一模块内容被拆成多个卡片/不在同一框内”的显示问题（内部列表/编号不再被当成同级块）


## v0.7.4
- 面板新增“最大回复token数”（独立API）输入框，显示/设置自定义API的最大token


## v0.7.4
- 修复独立API请求 max_tokens 固定为 4096 的问题：现在会使用你设置的“最大回复token数”
- 直连 fallback 也会携带 max_tokens/top_p


## v0.7.4
- 修复列表型模块（如【1】【2】提示）被拆成多个块：标准模式下合并为同一模块卡片内
- 将缩进从2空格调整为4空格，确保内部编号/列表不会跑出模块卡片


## v0.7.4
- 每个模块卡片支持点击“缩放放大/还原”（ESC/点击背景关闭）


## v0.7.4
- 独立API新增 stream 选项（可切换 stream=true/false）
- 支持解析常见 OpenAI SSE 流式返回（内部仍会等待结束后再追加分析框）


## v0.7.4
- 设置面板适配手机端：左右栏改为上下单栏，避免横向溢出；使用单滚动区域


## v0.7.4
- 面板“分析当前剧情”结果会同步追加到聊天末尾（面板报告框），解析失败也会追加原文
- 独立API输出非JSON时会自动重试一次强制JSON提示
- inline 解析失败时也会在聊天末尾显示原文，避免“有输出但看不到”


## v0.7.4
- 卡片点击行为调整：由“放大弹窗”改为“缩放/折叠（就地收起/展开）”


## v0.7.4
- 卡片折叠样式调整：折叠后仅显示标题（如“与原著对照 · 偏离影响”）


## v0.7.4
- 修复手机端面板顶部标题栏被挤出屏幕：移动端不再垂直居中、使用 100dvh，并让标题栏 sticky


## v0.7.4
- 聊天区“生成/重Roll”按钮支持拖动：拖动手柄⋮⋮可固定位置；双击手柄恢复自动贴近发送键


## 图谱/地图（v0.8.0）

- 在设置面板中打开【图谱/地图】卡片，可导入/导出/清空本聊天图谱，并打开图谱面板。
- 在分析输入中可选注入图谱摘要（便于模型理解角色/地点关系）。
- 若勾选“允许从输出中读取 <MapUpdate> 更新图谱”，则模型输出中出现 `<MapUpdate>[...]</MapUpdate>` 会自动更新图谱。

### MapUpdate 格式（示例）

```json
[
  {"op":"add_or_update_node","id":"alice","name":"爱丽丝","type":"character","x":420,"y":240},
  {"op":"add_or_update_node","id":"bob","name":"鲍勃","type":"character","x":650,"y":320},
  {"op":"add_or_update_edge","from":"alice","to":"bob","label":"同盟"}
]
```


## 外部世界信息源（v0.9.0）

- 在设置中填写一个 URL（例如本地世界引擎/游戏服务提供的 world-state 接口）。
- 点击“刷新世界信息”后，插件会缓存返回内容，并可选择注入到分析输入或用于 AI 自动生成地图。
- 注意：该 URL 需要允许浏览器跨域访问（CORS），或通过同域转发。

### 推荐的接口返回格式（示例）

返回 `application/json`：

```json
{
  "world": "Goblin Slayer",
  "time": "U.C.0087",
  "current_location": "green_noa_1",
  "characters": ["Kamille", "Quattro"],
  "factions": ["Titans", "AEUG"],
  "notes": "..."
}
```

或返回纯文本也可以。
